<?xml version="1.0" encoding="UTF-8"?><!--ant--><!--
	This file is part of the DITA-OT Prism-JS Plug-in project.
	See the accompanying LICENSE file for applicable licenses.
--><project xmlns:if="ant:if" xmlns:unless="ant:unless" xmlns:dita="http://dita-ot.sourceforge.net" name="fox.jason.prismjs">

	<target name="prismjs.copyfiles">
		<tempfile deleteonexit="true" destdir="${dita.temp.dir}" property="prismjs.temp.file" suffix=".js"/>
		<tempfile deleteonexit="true" destdir="${dita.temp.dir}" property="prismjs.formats.temp.file" suffix=".txt"/>
		<tempfile deleteonexit="true" destdir="${dita.temp.dir}" property="prismjs.css.temp.file" suffix=".css"/>
		<copy file="${dita.plugin.fox.jason.prismjs.dir}/resource/prism.js" toFile="${prismjs.temp.file}"/>
		<copy file="${dita.plugin.fox.jason.prismjs.dir}/resource/style.css" toFile="${prismjs.css.temp.file}"/>
		<echo message="@format='dita' or @format='md' or @format='markdown'" file="${prismjs.formats.temp.file}"/>
	</target>

	<target name="prismjs.init" depends="prismjs.copyfiles">
		<scriptdef language="javascript" name="prismjs" src="${dita.plugin.fox.jason.prismjs.dir}/resource/invoke-prism.js">
			<attribute name="name"/>
			<attribute name="class"/>
			<attribute name="text"/>
			<attribute name="outputclass"/>
			<attribute name="xtrc"/>
			<attribute name="xtrf"/>
			<attribute name="highlighted"/>
		</scriptdef>

    	<!-- Only run the Highlight transform for HTML or PDF -->
    	<condition property="is.highlightable">
			<or>
			<isset property="args.xsl"/>
				<isset property="args.rellinks"/>
      		</or>
		</condition>

		<condition property="is.html">
			<equals arg1="${out.ext}" arg2=".html"/>
	    </condition>

	    <loadfile property="prism.js.formats" srcFile="${prismjs.formats.temp.file}"/>
		
	</target>

	<target name="prismjs.css" if:set="is.html">
	    <copy tofile="${output.dir}/prism.css" file="${prismjs.css.temp.file}"/>
	</target>

	<target name="prismjs.highlight">
		<xmltask taskname="read-job.xml" if:set="is.highlightable" source="${dita.temp.dir}${file.separator}.job.xml">
			<call path="//file[${prism.js.formats}]">
				<param default="" name="path" path="@path"/>
				<actions>
					<local name="source"/>
					<property name="source" value="${dita.temp.dir}${file.separator}@{path}"/>
					<echo taskname="prismjs" level="verbose" message="Processing ${source}"/>
					<xmltask source="${source}" taskname="highlight-code">
						<call path="//*[(self::codeblock or self::codeph)]">
							<param default="" name="text" path="text()"/>
							<param default="" name="name" path="name()"/>
							<param default="" name="class" path="@class"/>
							<param default="" name="outputclass" path="@outputclass"/>
							<param default="" name="xtrc" path="@xtrc"/>
							<param default="" name="xtrf" path="@xtrf"/>
							<param default="" name="default" path="ancestor::body/@outputclass"/>
							<actions>
								<local name="lang"/>
								<local name="highlighted"/>
								<condition property="lang" value="@{default}" else="@{outputclass}">
									<equals arg1="@{outputclass}" arg2=""/>
								</condition>
								<echo unless:blank="${lang}" taskname="prismjs" message="@{xtrf}" level="debug"/>
								<echo unless:blank="${lang}" taskname="prismjs" message="@{xtrc}" level="debug"/>
								<echo unless:blank="${lang}" taskname="prismjs" message="${lang}" level="debug"/>
								<prismjs unless:blank="${lang}" xtrc="@{xtrc}" xtrf="@{xtrf}" name="@{name}" class="@{class}" text="@{text}" outputclass="${lang}" highlighted="highlighted"/>

								<xmltask unless:blank="${lang}" outputter="default" indent="false" source="${source}" dest="${source}">
									<replace path="//*[@xtrc='@{xtrc}']" withXml="${highlighted}"/>
								</xmltask>
							</actions>
						</call>
					</xmltask>
				</actions>
			</call>
		</xmltask>
    </target>

    <target name="prismjs" depends="prismjs.init,prismjs.highlight,prismjs.css"/>

</project>